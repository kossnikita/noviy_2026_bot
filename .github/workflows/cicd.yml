name: CI (Tests + GHCR)

on:
  push:
    branches: [main, master]
  pull_request:
  workflow_dispatch: {}

permissions:
  contents: read
  packages: write

jobs:
  pytest:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        python-version: ["3.12", "3.13", "3.14"]

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
          cache: pip

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install -r requirements-dev.txt

      - name: Run tests
        run: |
          pytest -q

  build-and-push:
    needs: pytest
    if: github.event_name != 'pull_request'
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v2

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2

      - name: Log in to GHCR
        uses: docker/login-action@v2
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push
        uses: docker/build-push-action@v4
        with:
          context: .
          file: ./Dockerfile
          platforms: linux/amd64,linux/arm64
          push: true
          tags: |
            ghcr.io/${{ github.repository_owner }}/party-bot:latest
            ghcr.io/${{ github.repository_owner }}/party-bot:${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  deploy:
    needs: build-and-push
    if: github.event_name != 'pull_request' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Install jq
        run: |
          sudo apt-get update
          sudo apt-get install -y jq

      - name: Validate Portainer secrets
        env:
          PORTAINER_HOST: ${{ secrets.PORTAINER_HOST }}
          PORTAINER_API_KEY: ${{ secrets.PORTAINER_API_KEY }}
          STACK_ID: ${{ secrets.PORTAINER_STACK_ID }}
          ENDPOINT_ID: ${{ secrets.PORTAINER_ENDPOINT_ID }}
          STACK_NAME: ${{ secrets.PORTAINER_STACK_NAME }}
        run: |
          set -euo pipefail

          : "${PORTAINER_HOST:?Missing PORTAINER_HOST secret}"
          : "${PORTAINER_API_KEY:?Missing PORTAINER_API_KEY secret}"
          : "${STACK_ID:?Missing PORTAINER_STACK_ID secret}"
          : "${ENDPOINT_ID:?Missing PORTAINER_ENDPOINT_ID secret}"
          : "${STACK_NAME:?Missing PORTAINER_STACK_NAME secret}"

          echo "Secrets look OK."

      - name: Fetch stack metadata (Env)
        env:
          PORTAINER_HOST: ${{ secrets.PORTAINER_HOST }}
          PORTAINER_API_KEY: ${{ secrets.PORTAINER_API_KEY }}
          STACK_ID: ${{ secrets.PORTAINER_STACK_ID }}
        run: |
          set -euo pipefail

          curl -fSsL \
            -H "X-API-Key: $PORTAINER_API_KEY" \
            "$PORTAINER_HOST/api/stacks/$STACK_ID" \
            -o stack.json

          jq '.Env' stack.json > env.json
          echo "Fetched stack Env (count=$(jq 'length' env.json))."

      - name: Fetch stack compose file
        env:
          PORTAINER_HOST: ${{ secrets.PORTAINER_HOST }}
          PORTAINER_API_KEY: ${{ secrets.PORTAINER_API_KEY }}
          STACK_ID: ${{ secrets.PORTAINER_STACK_ID }}
          ENDPOINT_ID: ${{ secrets.PORTAINER_ENDPOINT_ID }}
        run: |
          set -euo pipefail

          curl -fSsL \
            -H "X-API-Key: $PORTAINER_API_KEY" \
            "$PORTAINER_HOST/api/stacks/$STACK_ID/file?endpointId=$ENDPOINT_ID" \
            -o stack_file.json

          jq -r '.StackFileContent' stack_file.json > docker-compose.yml
          echo "Fetched compose file (lines=$(wc -l < docker-compose.yml))."

      - name: Build redeploy payload
        env:
          STACK_NAME: ${{ secrets.PORTAINER_STACK_NAME }}
        run: |
          set -euo pipefail

          env_json=$(cat env.json)

          jq -n \
            --arg name "$STACK_NAME" \
            --rawfile stackFile docker-compose.yml \
            --argjson env "$env_json" \
            '{
              Name: $name,
              StackFileContent: $stackFile,
              PullImage: true,
              Prune: true,
              Env: $env
            }' > payload.json

          echo "Payload built (bytes=$(wc -c < payload.json))."

      - name: Redeploy Portainer stack
        env:
          PORTAINER_HOST: ${{ secrets.PORTAINER_HOST }}
          PORTAINER_API_KEY: ${{ secrets.PORTAINER_API_KEY }}
          STACK_ID: ${{ secrets.PORTAINER_STACK_ID }}
          ENDPOINT_ID: ${{ secrets.PORTAINER_ENDPOINT_ID }}
        run: |
          set -euo pipefail

          response_file=response.txt
          http_code=$(curl -sS -w "%{http_code}" -o "$response_file" \
            -X PUT \
            "$PORTAINER_HOST/api/stacks/$STACK_ID?endpointId=$ENDPOINT_ID" \
            -H "X-API-Key: $PORTAINER_API_KEY" \
            -H "Content-Type: application/json" \
            --data-binary @payload.json)

          echo "HTTP status: $http_code"
          if [ "$http_code" != "200" ]; then
            echo "Redeploy failed (HTTP $http_code)"
            echo "Response body:"
            cat "$response_file"
            exit 1
          fi

          echo "Stack redeployed successfully"
